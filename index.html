<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkMaster Shopping Enterprise v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @media print {
            @page { margin: 0; size: 80mm auto; }
            body * { display: none !important; }
            #ticketPrint, #ticketPrint * { display: block !important; visibility: visible !important; }
            #ticketPrint { position: absolute; left: 0; top: 0; width: 75mm !important; padding: 2mm; text-align: center; }
            .no-print { display: none !important; }
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid-patio { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-slate-900 text-white px-6 py-3 flex justify-between items-center shadow-2xl border-b border-emerald-500/30">
        <div class="flex items-center gap-4">
            <div class="bg-emerald-500 text-slate-900 p-2 rounded-xl font-black italic">SHOPPING 5.0</div>
            <div>
                <h1 id="displayNomeShopping" class="text-lg font-black uppercase tracking-tighter text-emerald-400">CARREGANDO...</h1>
                <p id="infoCaixaHeader" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Caixa Fechado</p>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div id="relogio" class="font-mono text-xl font-bold text-white">00:00:00</div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-80 bg-white border-r shadow-2xl p-6 flex flex-col gap-4 z-10">
            <div class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                <label class="text-[10px] font-black text-slate-400 uppercase mb-2 block italic">Leitura de Placa ou Ticket</label>
                <input id="inputPrincipal" type="text" autofocus
                    class="w-full bg-white border-2 border-slate-200 focus:border-emerald-500 rounded-xl p-4 text-2xl font-black text-center uppercase outline-none transition-all shadow-inner" 
                    placeholder="BIPE OU DIGITE" onkeyup="if(event.key === 'Enter') processarFluxo()">
                
                <div class="grid grid-cols-1 mt-3 gap-2">
                    <select id="tipoVeiculo" class="w-full p-3 bg-white border rounded-xl font-bold text-sm shadow-sm cursor-pointer">
                        <option value="CARRO">?? CARRO</option>
                        <option value="MOTO">??? MOTO</option>
                        <option value="CAMINHAO">?? CAMINHÃO</option>
                    </select>
                </div>
            </div>

            <div id="painelSaida" class="hidden flex-1 bg-emerald-600 rounded-3xl p-5 text-white shadow-xl overflow-y-auto animate-pulse-once">
                <div class="flex justify-between items-center mb-4">
                    <span class="font-black text-xs uppercase tracking-widest opacity-80">Finalizar Saída</span>
                    <button onclick="cancelarSaida()" class="bg-white/20 hover:bg-white/40 rounded-full w-8 h-8 flex items-center justify-center font-bold">&times;</button>
                </div>
                <h2 id="outPlaca" class="text-4xl font-black text-center mb-1 drop-shadow-md">---</h2>
                <p id="outId" class="text-[10px] text-center mb-4 opacity-70 font-mono"></p>
                
                <div class="bg-white p-4 rounded-2xl text-center shadow-lg mb-4">
                    <span class="text-[10px] font-bold text-slate-400 block uppercase">Total a Pagar</span>
                    <div id="outValor" class="text-4xl font-black text-slate-900">R$ 0,00</div>
                    <span id="outTempo" class="text-[10px] font-bold text-emerald-600 uppercase">0 MINUTOS</span>
                </div>

                <div class="space-y-2">
                    <select id="selectConv" onchange="aplicarConv()" class="w-full p-3 rounded-xl border-none text-slate-900 font-bold text-xs shadow-md"></select>
                    
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="finalizar('DINHEIRO')" class="bg-slate-900 hover:bg-black text-white p-3 rounded-xl font-black text-[10px] uppercase transition-all">?? Dinheiro</button>
                        <button onclick="finalizar('PIX')" class="bg-slate-900 hover:bg-black text-white p-3 rounded-xl font-black text-[10px] uppercase transition-all">?? PIX</button>
                        <button onclick="finalizar('DEBITO')" class="bg-slate-100 hover:bg-white text-slate-900 p-3 rounded-xl font-black text-[10px] uppercase transition-all shadow-md">?? Débito</button>
                        <button onclick="finalizar('CREDITO')" class="bg-slate-100 hover:bg-white text-slate-900 p-3 rounded-xl font-black text-[10px] uppercase transition-all shadow-md">?? Crédito</button>
                    </div>
                </div>
            </div>

            <div class="mt-auto space-y-2">
                <div class="bg-slate-900 text-white p-5 rounded-3xl shadow-lg border-b-4 border-emerald-500">
                    <span class="block text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-1">Caixa Operacional</span>
                    <span id="valorEmCaixa" class="text-2xl font-black">R$ 0,00</span>
                    <button onclick="abrirFecharCaixa()" id="btnCaixa" class="w-full mt-3 bg-emerald-500 hover:bg-emerald-400 text-slate-900 py-3 rounded-xl font-black text-[11px] uppercase transition-colors">Abrir Caixa</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-50">
            <nav class="flex gap-4 p-4 border-b bg-white">
                <button onclick="changeTab('operacao')" class="tab-btn px-6 py-3 rounded-xl font-black text-xs bg-emerald-500 text-white shadow-lg transition-all">PÁTIO EM TEMPO REAL</button>
                <button onclick="changeTab('config')" class="tab-btn px-6 py-3 rounded-xl font-black text-xs text-slate-500 hover:bg-slate-100">TARIFADOR</button>
                <button onclick="changeTab('convenios')" class="tab-btn px-6 py-3 rounded-xl font-black text-xs text-slate-500 hover:bg-slate-100">CONVÊNIOS</button>
                <button onclick="changeTab('financeiro')" class="tab-btn px-6 py-3 rounded-xl font-black text-xs text-slate-500 hover:bg-slate-100">FINANCEIRO</button>
                <button onclick="changeTab('shopConfig')" class="tab-btn px-6 py-3 rounded-xl font-black text-xs text-slate-500 hover:bg-slate-100">DADOS SHOPPING</button>
            </nav>

            <div class="flex-1 overflow-auto p-8">
                <div id="tab-operacao" class="tab-content active">
                    <div id="gridPatio" class="grid-patio"></div>
                </div>

                <div id="tab-config" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="tarifarioContainer"></div>
                    <div class="mt-8 p-6 bg-white rounded-3xl border text-right">
                        <button onclick="salvarConfig()" class="bg-slate-900 text-white px-12 py-4 rounded-2xl font-black uppercase hover:scale-105 transition-transform">Salvar Novos Preços</button>
                    </div>
                </div>

                <div id="tab-shopConfig" class="tab-content">
                    <div class="max-w-2xl bg-white p-8 rounded-3xl border shadow-sm space-y-4">
                        <h3 class="font-black text-lg uppercase mb-4 text-emerald-600 italic">Configuração do Estabelecimento</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="text-[10px] font-black uppercase text-slate-400">Nome do Shopping / Estacionamento</label>
                                <input id="cfgNome" type="text" class="w-full p-3 border rounded-xl font-bold">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400">CNPJ</label>
                                <input id="cfgCnpj" type="text" class="w-full p-3 border rounded-xl font-bold" placeholder="00.000.000/0000-00">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400">Telefone</label>
                                <input id="cfgTel" type="text" class="w-full p-3 border rounded-xl font-bold" placeholder="(00) 0000-0000">
                            </div>
                            <div class="col-span-2">
                                <label class="text-[10px] font-black uppercase text-slate-400">Endereço Completo</label>
                                <input id="cfgEnd" type="text" class="w-full p-3 border rounded-xl font-bold">
                            </div>
                        </div>
                        <button onclick="salvarDadosShopping()" class="w-full bg-emerald-500 text-slate-900 font-black py-4 rounded-xl uppercase mt-4">Atualizar Informações</button>
                    </div>
                </div>

                <div id="tab-financeiro" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-8 border rounded-3xl shadow-sm">
                            <h3 class="font-black text-xs uppercase mb-6 text-slate-400 tracking-widest">Desempenho Anual Consolidado</h3>
                            <canvas id="chartAnual"></canvas>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-slate-900 text-white p-10 rounded-[40px] shadow-2xl relative overflow-hidden">
                                <div class="relative z-10">
                                    <span class="uppercase text-[10px] tracking-widest text-emerald-400 font-black">Faturamento Hoje</span>
                                    <h2 id="finTotalHoje" class="text-6xl font-black mt-2">R$ 0,00</h2>
                                </div>
                                <div class="absolute -right-10 -bottom-10 opacity-10 text-9xl">??</div>
                            </div>
                            <div class="bg-white border p-6 rounded-3xl">
                                <h3 class="font-black text-[10px] uppercase mb-4 text-slate-400 italic">Detalhamento por Método</h3>
                                <div id="resumoPagamentos" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-convenios" class="tab-content">
                   <div id="areaConvenios" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-3xl border h-fit">
                            <h3 class="font-black text-xs uppercase mb-4 italic">Novo Parceiro</h3>
                            <input id="cNome" placeholder="NOME DA LOJA" class="w-full p-3 border rounded-xl mb-3 font-bold text-xs uppercase">
                            <input id="cDesc" type="number" placeholder="DESCONTO %" class="w-full p-3 border rounded-xl mb-4 font-bold text-xs">
                            <button onclick="cadastrarConvenio()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black text-xs uppercase">Cadastrar</button>
                        </div>
                        <div id="cardsConvenios" class="col-span-2 grid grid-cols-2 lg:grid-cols-3 gap-4"></div>
                   </div>
                </div>

            </div>
        </main>
    </div>

    <div id="ticketPrint" style="display: none; font-family: 'Courier New', Courier, monospace;">
        <div id="conteudoImpressao"></div>
    </div>

    <script>
        const ICONES = { CARRO: '??', MOTO: '???', CAMINHAO: '??' };
        
        let db = {
            patio: JSON.parse(localStorage.getItem('pmp5_patio')) || [],
            vendas: JSON.parse(localStorage.getItem('pmp5_vendas')) || [],
            convenios: JSON.parse(localStorage.getItem('pmp5_conv')) || [],
            shop: JSON.parse(localStorage.getItem('pmp5_shop')) || {
                nome: "Shopping Center Park",
                cnpj: "00.000.000/0001-00",
                tel: "(11) 4004-0000",
                end: "Av. Principal, 1000 - Centro"
            },
            config: JSON.parse(localStorage.getItem('pmp5_cfg')) || {
                tarifas: {
                    CARRO: { fracao: 12, hora: 22, diaria: 90, pernoite: 60 },
                    MOTO: { fracao: 6, hora: 12, diaria: 45, pernoite: 30 },
                    CAMINHAO: { fracao: 25, hora: 50, diaria: 180, pernoite: 120 }
                }
            },
            caixa: JSON.parse(localStorage.getItem('pmp5_caixa')) || { aberto: false, saldo: 0 }
        };

        let veiculoSaindo = null;

        // --- INICIALIZAÇÃO ---
        function init() {
            renderPatio();
            renderCaixa();
            renderTarifas();
            document.getElementById('displayNomeShopping').innerText = db.shop.nome;
            document.getElementById('cfgNome').value = db.shop.nome;
            document.getElementById('cfgCnpj').value = db.shop.cnpj;
            document.getElementById('cfgTel').value = db.shop.tel;
            document.getElementById('cfgEnd').value = db.shop.end;
        }

        // --- CAIXA ---
        function abrirFecharCaixa() {
            if (!db.caixa.aberto) {
                const v = prompt("Valor inicial do troco (R$):", "0");
                if (v === null) return;
                db.caixa.aberto = true;
                db.caixa.saldo = parseFloat(v);
            } else {
                if (confirm(`FECHAMENTO DE CAIXA\nSaldo Final: R$ ${db.caixa.saldo.toFixed(2)}\nDeseja encerrar o turno?`)) {
                    db.caixa.aberto = false;
                }
            }
            salvar();
            renderCaixa();
        }

        function renderCaixa() {
            document.getElementById('valorEmCaixa').innerText = `R$ ${db.caixa.saldo.toFixed(2)}`;
            document.getElementById('btnCaixa').innerText = db.caixa.aberto ? "Encerrar Turno" : "Abrir Caixa";
            document.getElementById('btnCaixa').className = db.caixa.aberto 
                ? "w-full mt-3 bg-red-500 hover:bg-red-400 text-white py-3 rounded-xl font-black text-[11px] uppercase transition-colors" 
                : "w-full mt-3 bg-emerald-500 hover:bg-emerald-400 text-slate-900 py-3 rounded-xl font-black text-[11px] uppercase transition-colors";
            document.getElementById('infoCaixaHeader').innerText = db.caixa.aberto ? "SISTEMA OPERACIONAL" : "SISTEMA BLOQUEADO (ABRA O CAIXA)";
        }

        // --- OPERAÇÃO ---
        function processarFluxo() {
            if (!db.caixa.aberto) { alert("ERRO: Caixa Fechado!"); return; }
            const input = document.getElementById('inputPrincipal').value.toUpperCase().trim();
            if (input.length < 3) return;

            // Busca por placa ou ID (Ticket)
            const v = db.patio.find(item => item.placa === input || item.id.toString().slice(-6) === input);
            
            if (v) prepararSaida(v);
            else entrada(input);
            
            document.getElementById('inputPrincipal').value = '';
        }

        function entrada(placa) {
            if(placa.length < 7) { alert("Placa inválida!"); return; }
            const tipo = document.getElementById('tipoVeiculo').value;
            const novo = { id: Date.now(), placa, tipo, entrada: new Date().toISOString() };
            db.patio.push(novo);
            salvar();
            imprimirTicketEntrada(novo);
            renderPatio();
        }

        function renderPatio() {
            const grid = document.getElementById('gridPatio');
            grid.innerHTML = db.patio.map(v => {
                const min = Math.ceil((new Date() - new Date(v.entrada)) / 60000);
                return `
                <div onclick="prepararSaida(${JSON.stringify(v).replace(/"/g, '&quot;')})" 
                     class="bg-white border-2 border-slate-200 p-5 rounded-[2rem] hover:border-emerald-500 hover:shadow-xl cursor-pointer transition-all flex flex-col items-center text-center group">
                    <span class="text-4xl mb-2 group-hover:scale-110 transition-transform">${ICONES[v.tipo]}</span>
                    <span class="font-black text-xl text-slate-900">${v.placa}</span>
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${v.tipo} | Ticket: #${v.id.toString().slice(-6)}</span>
                    <div class="mt-3 px-3 py-1 bg-slate-100 rounded-full font-black text-emerald-600 text-xs">${min} MIN</div>
                </div>`;
            }).reverse().join('');
        }

        function prepararSaida(v) {
            veiculoSaindo = v;
            const min = Math.ceil((new Date() - new Date(v.entrada)) / 60000);
            const t = db.config.tarifas[v.tipo];
            
            let valor = 0;
            if (min <= 15) valor = t.fracao;
            else if (min <= 60) valor = t.hora;
            else if (min <= 720) valor = Math.ceil(min/60) * t.hora;
            else if (min <= 1440) valor = t.diaria;
            else valor = (Math.ceil(min/1440) * t.diaria) + t.pernoite;

            document.getElementById('outPlaca').innerText = v.placa;
            document.getElementById('outId').innerText = `TICKET #${v.id.toString().slice(-6)}`;
            document.getElementById('outValor').innerText = `R$ ${valor.toFixed(2)}`;
            document.getElementById('outTempo').innerText = `${min} MINUTOS DE PERMANÊNCIA`;
            document.getElementById('painelSaida').classList.remove('hidden');
            renderConveniosSelect();
        }

        function finalizar(metodo) {
            const valor = parseFloat(document.getElementById('outValor').innerText.replace('R$ ',''));
            db.vendas.push({ data: new Date().toISOString(), valor, metodo, placa: veiculoSaindo.placa });
            db.caixa.saldo += (metodo === 'DINHEIRO' ? valor : 0); // Só dinheiro soma ao saldo físico
            db.patio = db.patio.filter(v => v.id !== veiculoSaindo.id);
            salvar();
            cancelarSaida();
            renderPatio();
            renderCaixa();
            alert("Venda registrada com sucesso!");
        }

        // --- CONFIGURAÇÃO SHOPPING ---
        function salvarDadosShopping() {
            db.shop = {
                nome: document.getElementById('cfgNome').value,
                cnpj: document.getElementById('cfgCnpj').value,
                tel: document.getElementById('cfgTel').value,
                end: document.getElementById('cfgEnd').value
            };
            salvar();
            document.getElementById('displayNomeShopping').innerText = db.shop.nome;
            alert("Dados do Shopping atualizados!");
        }

        // --- IMPRESSÃO ---
        function imprimirTicketEntrada(v) {
            const ticketId = v.id.toString().slice(-6);
            const html = `
                <div style="padding: 10px; border: 1px solid #000; border-radius: 5px;">
                    <h2 style="margin: 0; font-size: 18px;">${db.shop.nome}</h2>
                    <p style="font-size: 9px; margin: 2px 0;">CNPJ: ${db.shop.cnpj}</p>
                    <p style="font-size: 9px; margin: 0;">${db.shop.end}</p>
                    <hr style="border: 1px dashed #000; margin: 10px 0;">
                    <h1 style="font-size: 45px; margin: 5px 0;">${v.placa}</h1>
                    <p style="font-size: 14px; font-weight: bold; margin: 0;">${v.tipo} - TICKET #${ticketId}</p>
                    <p style="font-size: 11px; margin: 5px 0;">ENTRADA: ${new Date(v.entrada).toLocaleString()}</p>
                    <div style="margin: 10px auto; display: inline-block;">
                        <svg id="barcodeTicket"></svg>
                    </div>
                    <hr style="border: 1px dashed #000; margin: 10px 0;">
                    <p style="font-size: 8px; text-align: justify;">A guarda do veículo é limitada ao período indicado. Não nos responsabilizamos por objetos deixados no interior. Em caso de perda do ticket, será cobrada taxa conforme regulamento.</p>
                </div>
            `;
            document.getElementById('conteudoImpressao').innerHTML = html;
            JsBarcode("#barcodeTicket", ticketId, { format: "CODE128", height: 40, width: 2, displayValue: false });
            setTimeout(() => window.print(), 300);
        }

        // --- FINANCEIRO ---
        function renderFinanceiro() {
            const hoje = new Date().toISOString().split('T')[0];
            const vendasHoje = db.vendas.filter(v => v.data.startsWith(hoje));
            const total = vendasHoje.reduce((a, b) => a + b.valor, 0);
            document.getElementById('finTotalHoje').innerText = `R$ ${total.toFixed(2)}`;

            const metodos = ['DINHEIRO', 'PIX', 'DEBITO', 'CREDITO'];
            document.getElementById('resumoPagamentos').innerHTML = metodos.map(m => {
                const soma = vendasHoje.filter(v => v.metodo === m).reduce((a, b) => a + b.valor, 0);
                return `<div class="flex justify-between font-bold text-sm border-b pb-1 text-slate-600">
                    <span>${m}</span><span>R$ ${soma.toFixed(2)}</span>
                </div>`;
            }).join('');

            // Gráfico Anual
            const ctx = document.getElementById('chartAnual').getContext('2d');
            const dados = new Array(12).fill(0);
            db.vendas.forEach(v => {
                const d = new Date(v.data);
                if(d.getFullYear() === new Date().getFullYear()) dados[d.getMonth()] += v.valor;
            });

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    datasets: [{ label: 'Receita Mensal', data: dados, backgroundColor: '#10b981', borderRadius: 8 }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }

        // --- TARIFAS ---
        function renderTarifas() {
            const container = document.getElementById('tarifarioContainer');
            container.innerHTML = Object.keys(db.config.tarifas).map(cat => `
                <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                    <h3 class="font-black text-xl mb-5 flex items-center gap-2">${ICONES[cat]} ${cat}</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center"><label class="text-[10px] font-black uppercase text-slate-400">15 min (Frac)</label>
                        <input id="tar_${cat}_fracao" type="number" value="${db.config.tarifas[cat].fracao}" class="w-20 p-2 border rounded-xl text-center font-black"></div>
                        <div class="flex justify-between items-center"><label class="text-[10px] font-black uppercase text-slate-400">Hora Cheia</label>
                        <input id="tar_${cat}_hora" type="number" value="${db.config.tarifas[cat].hora}" class="w-20 p-2 border rounded-xl text-center font-black"></div>
                        <div class="flex justify-between items-center"><label class="text-[10px] font-black uppercase text-slate-400">Diária</label>
                        <input id="tar_${cat}_diaria" type="number" value="${db.config.tarifas[cat].diaria}" class="w-20 p-2 border rounded-xl text-center font-black"></div>
                        <div class="flex justify-between items-center"><label class="text-[10px] font-black uppercase text-slate-400">Pernoite</label>
                        <input id="tar_${cat}_pernoite" type="number" value="${db.config.tarifas[cat].pernoite}" class="w-20 p-2 border rounded-xl text-center font-black"></div>
                    </div>
                </div>
            `).join('');
        }

        function salvarConfig() {
            Object.keys(db.config.tarifas).forEach(cat => {
                db.config.tarifas[cat].fracao = parseFloat(document.getElementById(`tar_${cat}_fracao`).value);
                db.config.tarifas[cat].hora = parseFloat(document.getElementById(`tar_${cat}_hora`).value);
                db.config.tarifas[cat].diaria = parseFloat(document.getElementById(`tar_${cat}_diaria`).value);
                db.config.tarifas[cat].pernoite = parseFloat(document.getElementById(`tar_${cat}_pernoite`).value);
            });
            salvar();
            alert("Tarifário Atualizado!");
        }

        // --- AUXILIARES ---
        function salvar() {
            localStorage.setItem('pmp5_patio', JSON.stringify(db.patio));
            localStorage.setItem('pmp5_vendas', JSON.stringify(db.vendas));
            localStorage.setItem('pmp5_cfg', JSON.stringify(db.config));
            localStorage.setItem('pmp5_caixa', JSON.stringify(db.caixa));
            localStorage.setItem('pmp5_conv', JSON.stringify(db.convenios));
            localStorage.setItem('pmp5_shop', JSON.stringify(db.shop));
        }

        function changeTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.replace('bg-emerald-500', 'text-slate-500'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('text-white', 'shadow-lg'));
            document.getElementById('tab-' + id).classList.add('active');
            event.currentTarget.classList.replace('text-slate-500', 'bg-emerald-500');
            event.currentTarget.classList.add('text-white', 'shadow-lg');
            if(id === 'financeiro') renderFinanceiro();
            if(id === 'config') renderTarifas();
            if(id === 'convenios') renderConveniosCards();
        }

        function renderConveniosSelect() {
            const sel = document.getElementById('selectConv');
            sel.innerHTML = '<option value="0">?? TABELA PADRÃO (SEM DESCONTO)</option>' + 
                            db.convenios.map(c => `<option value="${c.id}">${c.nome} (-${c.desconto}%)</option>`).join('');
        }

        function aplicarConv() {
            const id = document.getElementById('selectConv').value;
            prepararSaida(veiculoSaindo); 
            if(id == "0") return;
            const c = db.convenios.find(item => item.id == id);
            let atual = parseFloat(document.getElementById('outValor').innerText.replace('R$ ',''));
            let novo = atual * (1 - (c.desconto / 100));
            document.getElementById('outValor').innerText = `R$ ${novo.toFixed(2)}`;
        }

        function cadastrarConvenio() {
            const nome = document.getElementById('cNome').value.toUpperCase();
            const desc = document.getElementById('cDesc').value;
            if(!nome || !desc) return;
            db.convenios.push({ id: Date.now(), ean: '789' + Date.now().toString().slice(-10), nome, desconto: desc });
            salvar();
            renderConveniosCards();
            document.getElementById('cNome').value = '';
            document.getElementById('cDesc').value = '';
        }

        function renderConveniosCards() {
            document.getElementById('cardsConvenios').innerHTML = db.convenios.map(c => `
                <div class="bg-white border-2 p-5 rounded-3xl relative shadow-sm hover:border-emerald-500 transition-colors">
                    <span class="absolute top-4 right-4 bg-emerald-100 text-emerald-700 text-[10px] px-2 py-1 rounded-full font-black">${c.desconto}% OFF</span>
                    <p class="font-black text-sm uppercase text-slate-800">${c.nome}</p>
                    <button onclick="removerConv(${c.id})" class="mt-4 text-red-300 hover:text-red-500 text-[9px] font-bold uppercase tracking-widest">Excluir Parceiro</button>
                </div>
            `).join('');
        }

        function removerConv(id) {
            db.convenios = db.convenios.filter(c => c.id != id);
            salvar();
            renderConveniosCards();
        }

        function cancelarSaida() { document.getElementById('painelSaida').classList.add('hidden'); veiculoSaindo = null; }

        setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleTimeString(); }, 1000);
        
        init();
    </script>
</body>
</html>
